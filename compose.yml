services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: mydia_dev
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    profiles:
      - postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  app:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: mydia_dev
    environment:
      # User mapping for host filesystem permissions
      # Set via ./dev script to match host user
      LOCAL_UID: ${LOCAL_UID:-0}
      LOCAL_GID: ${LOCAL_GID:-0}

      # Phoenix configuration
      PHX_HOST: localhost
      PORT: 4000
      SECRET_KEY_BASE: "VlPUd2fbnWjh6Di+7SGc2SSXpNhI0hN766FFAlct65wU5ARyiGvK9r3TqSqKyu0K"

      # Database configuration (SQLite)
      DATABASE_PATH: /app/mydia_dev.db

      # Mix environment
      MIX_ENV: dev

      # Metadata relay configuration
      METADATA_RELAY_URL: ${METADATA_RELAY_URL:-https://relay.mydia.dev}

      # For interactive debugging
      MIX_HOME: /app/.mix
      HEX_HOME: /app/.hex

      # Flutter cache
      PUB_CACHE: /app/player/.pub-cache
    ports:
      - "4000:4000"
    volumes:
      # Mount source code for live reloading
      - .:/app

      # Persist build artifacts and dependencies across restarts
      - build_cache:/app/_build
      - deps_cache:/app/deps
      - mix_cache:/app/.mix
      - hex_cache:/app/.hex
      - node_modules:/app/assets/node_modules
      # Persist NIF cache to avoid redownloading/recompiling on every run
      - elixir_make_cache:/root/.cache/elixir_make
      # Persist Flutter pub cache
      - player_pub_cache:/app/player/.pub-cache
      # Isolate Flutter environment-specific directories from host (nix develop)
      # These contain SDK-specific artifacts that conflict between environments
      - player_dart_tool:/app/player/.dart_tool
      - player_build:/app/player/build
    stdin_open: true
    tty: true
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000"]
      interval: 30s
      timeout: 3s
      start_period: 40s
      retries: 3

volumes:
  player_pub_cache:
    driver: local
  # Flutter environment isolation (prevents conflicts with nix develop)
  player_dart_tool:
    driver: local
  player_build:
    driver: local
  # Named volumes for caching
  build_cache:
    driver: local
  deps_cache:
    driver: local
  mix_cache:
    driver: local
  hex_cache:
    driver: local
  node_modules:
    driver: local
  elixir_make_cache:
    driver: local
  # PostgreSQL data (only used with --profile postgres)
  postgres_data:
    driver: local
