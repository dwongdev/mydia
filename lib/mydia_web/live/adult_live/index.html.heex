<Layouts.app {assigns}>
  <div class="flex flex-col h-full" phx-window-keydown="keydown">
    <%!-- Header with title and view controls --%>
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 md:gap-4 mb-4 md:mb-6">
      <div>
        <h1 class="text-3xl font-bold">{@page_title}</h1>
        <p class="text-base-content/70 mt-1">
          Browse your adult library
        </p>
      </div>

      <%!-- Actions and view controls --%>
      <div class="flex items-center gap-2">
        <%!-- Selection controls --%>
        <.selection_controls
          selection_mode={@selection_mode}
          selected_count={MapSet.size(@selected_ids)}
        />

        <%!-- Re-scan button --%>
        <button
          type="button"
          class={[
            "btn btn-sm gap-2",
            @scanning && "btn-disabled loading"
          ]}
          phx-click="trigger_rescan"
          disabled={@scanning}
          title="Scan library for new files and generate thumbnails"
        >
          <%= if @scanning do %>
            <span class="loading loading-spinner loading-sm"></span>
            <span class="hidden sm:inline">Scanning...</span>
          <% else %>
            <.icon name="hero-arrow-path" class="w-4 h-4" />
            <span class="hidden sm:inline">Re-scan</span>
          <% end %>
        </button>

        <%!-- View mode toggle --%>
        <.view_mode_toggle view_mode={@view_mode} />
      </div>
    </div>

    <%!-- Search and Filters --%>
    <div class="flex flex-col md:flex-row gap-3 md:gap-4 mb-4 md:mb-6">
      <%!-- Search input --%>
      <div class="flex-1">
        <.form for={%{}} phx-change="search" id="adult-search-form" class="w-full">
          <input
            type="text"
            name="search"
            value={@search_query}
            placeholder="Search files..."
            phx-debounce="300"
            class="input input-bordered w-full"
          />
        </.form>
      </div>

      <%!-- Sort --%>
      <.form for={%{}} phx-change="filter" id="adult-filter-form" class="join">
        <select name="sort_by" class="select select-bordered join-item" title="Sort by">
          <option value="added_desc" selected={@sort_by == "added_desc"}>Added (Newest)</option>
          <option value="added_asc" selected={@sort_by == "added_asc"}>Added (Oldest)</option>
          <option value="name_asc" selected={@sort_by == "name_asc"}>Name (A-Z)</option>
          <option value="name_desc" selected={@sort_by == "name_desc"}>Name (Z-A)</option>
          <option value="size_desc" selected={@sort_by == "size_desc"}>Size (Largest)</option>
          <option value="size_asc" selected={@sort_by == "size_asc"}>Size (Smallest)</option>
        </select>
      </.form>
    </div>

    <%!-- Empty state --%>
    <%= if @files_empty? do %>
      <div class="flex flex-col items-center justify-center py-16">
        <.icon name="hero-film" class="w-16 h-16 text-error/50 mb-4" />
        <h3 class="text-xl font-semibold text-base-content/70 mb-2">No files found</h3>
        <p class="text-base-content/50">
          <%= if @search_query != "" do %>
            Try adjusting your search
          <% else %>
            Add files to your adult library to see them here
          <% end %>
        </p>
      </div>
    <% end %>

    <%!-- List View Header --%>
    <div :if={@view_mode == :list} class="card bg-base-100 shadow-lg overflow-hidden">
      <div class="flex items-center bg-base-200 font-semibold text-sm px-4 py-3 border-b border-base-300">
        <div class="w-10 flex-shrink-0"></div>
        <div class="w-14 flex-shrink-0"></div>
        <div class="flex-1 min-w-0">Filename</div>
        <div class="w-24 hidden md:block text-center flex-shrink-0">Resolution</div>
        <div class="w-24 hidden lg:block text-center flex-shrink-0">Size</div>
        <div class="w-28 hidden xl:block text-center flex-shrink-0">Added</div>
      </div>
    </div>

    <%!-- Files Container --%>
    <div
      id="files"
      phx-update="stream"
      phx-viewport-bottom="load_more"
      class={[
        @view_mode == :grid &&
          "grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4 md:gap-6 pb-6 md:pb-8",
        @view_mode == :list && "card bg-base-100 shadow-lg overflow-hidden -mt-px"
      ]}
    >
      <div :for={{id, file} <- @streams.files} id={id} class={@view_mode == :list && "contents"}>
        <%= if @view_mode == :grid do %>
          <%!-- Grid Card View with Sprite Preview --%>
          <div class="relative group">
            <%!-- Selection checkbox --%>
            <%= if @selection_mode do %>
              <div class="absolute top-2 left-2 z-10">
                <input
                  type="checkbox"
                  class="checkbox checkbox-primary checkbox-sm"
                  checked={item_selected?(@selected_ids, file.id)}
                  phx-click="toggle_select"
                  phx-value-id={file.id}
                />
              </div>
            <% end %>
            <.link
              navigate={~p"/adult/#{file.id}"}
              class="block"
              id={"card-#{file.id}"}
              phx-hook={
                cond do
                  file.preview_blob -> "VideoPreview"
                  file.sprite_blob -> "SpritePreview"
                  true -> nil
                end
              }
              data-preview-url={if file.preview_blob, do: get_preview_url(file)}
              data-sprite-url={if file.sprite_blob, do: get_sprite_url(file)}
              data-sprite-width="160"
              data-sprite-height="90"
              data-sprite-columns="9"
            >
              <div class="card bg-base-100 shadow-lg hover:shadow-xl transition-shadow duration-200 overflow-hidden">
                <figure class="relative aspect-video overflow-hidden bg-base-300">
                  <%!-- Thumbnail image --%>
                  <img
                    src={get_thumbnail_url(file)}
                    alt={get_display_name(file)}
                    class={[
                      "w-full h-full object-cover transition-all duration-300",
                      (file.sprite_blob || file.preview_blob) && "group-hover:opacity-0"
                    ]}
                    loading="lazy"
                    data-preview-thumbnail
                  />
                  <%!-- Video preview (takes priority over sprite) --%>
                  <%= if file.preview_blob do %>
                    <div class="absolute inset-0">
                      <video
                        class="w-full h-full object-cover opacity-0 transition-opacity duration-300"
                        data-preview-video
                        muted
                        playsinline
                        preload="none"
                      >
                      </video>
                      <div class="absolute bottom-0 left-0 right-0 h-1 bg-base-300/50">
                        <div
                          class="h-full bg-primary transition-all duration-100"
                          data-preview-progress
                          style="width: 0%"
                        >
                        </div>
                      </div>
                    </div>
                  <% else %>
                    <%!-- Sprite preview fallback --%>
                    <%= if file.sprite_blob do %>
                      <div
                        class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-200"
                        data-sprite-container
                      >
                        <canvas class="w-full h-full object-cover" data-sprite-canvas></canvas>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-base-300/50">
                          <div
                            class="h-full bg-primary transition-all duration-100"
                            data-sprite-progress
                            style="width: 0%"
                          >
                          </div>
                        </div>
                      </div>
                    <% end %>
                  <% end %>
                  <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                  </div>
                  <%!-- Top badges --%>
                  <div class={[
                    "absolute top-2 right-2 flex justify-end items-start gap-2 z-10",
                    @selection_mode && "left-9"
                  ]}>
                    <%= if duration = get_duration(file) do %>
                      <span class="badge badge-neutral badge-sm shadow-lg font-mono">
                        {format_duration(duration)}
                      </span>
                    <% end %>
                    <%= if resolution = format_resolution(file.resolution) do %>
                      <span class="badge badge-primary badge-sm shadow-lg">
                        {resolution}
                      </span>
                    <% end %>
                  </div>
                  <div class="absolute bottom-2 left-2 right-2 flex justify-between items-end z-10 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                    <span class="text-white text-xs font-medium drop-shadow-lg">
                      {format_file_size(file.size)}
                    </span>
                    <%= if file.preview_blob || file.sprite_blob do %>
                      <span class="text-white/70 text-xs drop-shadow-lg">
                        <.icon name="hero-play-circle" class="w-4 h-4 inline" /> Preview
                      </span>
                    <% end %>
                  </div>
                </figure>
                <div class="card-body p-3">
                  <h3 class="card-title text-sm line-clamp-2" title={get_display_name(file)}>
                    {get_display_name(file)}
                  </h3>
                </div>
              </div>
            </.link>
          </div>
        <% else %>
          <%!-- List Row View --%>
          <div class={[
            "flex items-center px-4 py-3 hover:bg-base-200/50 border-b border-base-200 last:border-b-0 odd:bg-base-100 even:bg-base-200/30 transition-colors",
            @selection_mode && item_selected?(@selected_ids, file.id) &&
              "bg-primary/10 hover:bg-primary/15"
          ]}>
            <%!-- Checkbox column --%>
            <div class="w-10 flex-shrink-0">
              <%= if @selection_mode do %>
                <input
                  type="checkbox"
                  class="checkbox checkbox-primary checkbox-sm"
                  checked={item_selected?(@selected_ids, file.id)}
                  phx-click="toggle_select"
                  phx-value-id={file.id}
                />
              <% end %>
            </div>
            <%!-- Thumbnail column --%>
            <div class="w-14 flex-shrink-0">
              <.link navigate={~p"/adult/#{file.id}"} class="block">
                <img
                  src={get_thumbnail_url(file)}
                  alt={get_display_name(file)}
                  loading="lazy"
                  class="w-12 h-8 rounded shadow-sm object-cover bg-base-300"
                />
              </.link>
            </div>
            <%!-- Filename column --%>
            <div class="flex-1 min-w-0 pr-4">
              <.link
                navigate={~p"/adult/#{file.id}"}
                class="font-medium hover:text-primary transition-colors line-clamp-1"
                title={get_display_name(file)}
              >
                {get_display_name(file)}
              </.link>
            </div>
            <%!-- Resolution column --%>
            <div class="w-24 hidden md:block text-center flex-shrink-0">
              <%= if resolution = format_resolution(file.resolution) do %>
                <span class="badge badge-primary badge-sm">{resolution}</span>
              <% else %>
                <span class="text-base-content/40">-</span>
              <% end %>
            </div>
            <%!-- Size column --%>
            <div class="w-24 hidden lg:block text-center text-base-content/70 text-sm flex-shrink-0">
              {format_file_size(file.size)}
            </div>
            <%!-- Added date column --%>
            <div class="w-28 hidden xl:block text-center text-base-content/70 text-sm flex-shrink-0">
              {format_date(file.inserted_at)}
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <%!-- Loading indicator for infinite scroll --%>
    <.loading_indicator visible={@has_more} />

    <%!-- Floating Action Toolbar (shown in selection mode) --%>
    <% all_selected =
      MapSet.equal?(@selected_ids, @all_visible_ids) and MapSet.size(@all_visible_ids) > 0 %>
    <.batch_action_toolbar
      selected_count={MapSet.size(@selected_ids)}
      selection_mode={@selection_mode}
      all_selected={all_selected}
    >
      <:actions :let={has_selection}>
        <div class="tooltip tooltip-top" data-tip="Delete">
          <button
            type="button"
            class={[
              "btn btn-sm btn-ghost btn-square text-error",
              !has_selection && "btn-disabled"
            ]}
            phx-click="show_delete_confirmation"
            disabled={!has_selection}
          >
            <.icon name="hero-trash" class="w-4 h-4" />
          </button>
        </div>
      </:actions>
    </.batch_action_toolbar>

    <%!-- Delete Confirmation Modal --%>
    <.delete_confirmation_modal
      id="delete-confirmation-modal"
      show={@show_delete_modal}
      selected_count={MapSet.size(@selected_ids)}
      delete_files={@delete_files}
      item_label="File"
    />
  </div>
</Layouts.app>
