FROM ghcr.io/cirruslabs/flutter:stable

# Install development dependencies
RUN apt-get update -qq && \
    apt-get install -y -qq --no-install-recommends \
        curl \
    && rm -rf /var/lib/apt/lists/*

# Pre-configure Flutter
RUN flutter config --no-analytics

WORKDIR /app/player

# Create entrypoint script
COPY <<'EOF' /entrypoint.sh
#!/bin/bash
set -e

cd /app/player

echo ''
echo '================================================='
echo 'Flutter Player - Development Environment'
echo '================================================='
echo ''

# Install dependencies
echo '→ Installing Flutter dependencies...'
flutter pub get

# Run initial code generation if needed
if [ -f "lib/graphql/schema.graphql.dart" ]; then
    echo '→ GraphQL codegen already exists, skipping initial build...'
else
    echo '→ Running initial code generation (GraphQL, Riverpod)...'
    flutter pub run build_runner build --delete-conflicting-outputs || true
fi

echo ''
echo '================================================='
echo 'Development Workflow'
echo '================================================='
echo ''
echo 'The build_runner is now watching for code changes.'
echo 'GraphQL and Riverpod files will regenerate automatically.'
echo ''
echo 'The Phoenix FlutterWatcher will trigger production builds'
echo 'when you edit Flutter source files (lib/, web/, pubspec.yaml).'
echo ''
echo 'Access the player at: http://localhost:4000/player'
echo ''
echo 'After making changes:'
echo '  1. Save your files'
echo '  2. Wait ~20-30 seconds for the build to complete'
echo '  3. Refresh your browser'
echo ''
echo '================================================='
echo ''
echo '→ Starting build_runner watch...'
echo ''

# Start build_runner watch in the background
flutter pub run build_runner watch --delete-conflicting-outputs &

# Keep container alive
exec tail -f /dev/null
EOF

RUN chmod +x /entrypoint.sh

CMD ["/entrypoint.sh"]
