# ============================================
# E2E Test Runner - Flutter Integration Tests
# ============================================
# This Dockerfile runs Flutter integration tests against
# a Selenium Chrome instance (not included - see compose).
#
# NOTE: This Dockerfile expects the build context to be the project root
# (not the player directory) so it can access priv/graphql/schema.graphql
#
# Environment variables required:
# - CHROMEDRIVER_URL: URL of the Selenium WebDriver (e.g., http://chrome:4444)
# - PLAYER_URL: URL of the Flutter web app to test
# - MYDIA_URL: URL of the Mydia server (for API calls)
# - RELAY_URL: URL of the metadata-relay service

FROM ghcr.io/cirruslabs/flutter:stable

# Install additional dependencies
RUN apt-get update -qq && \
    apt-get install -y -qq --no-install-recommends \
        curl \
        jq \
        socat \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy pubspec files first for better caching
COPY player/pubspec.yaml player/pubspec.lock ./

# Install dependencies
RUN flutter pub get

# Copy the rest of the player app
COPY player/ .

# Remove the broken symlink and copy the actual schema file
RUN rm -f lib/graphql/schema.graphql
COPY priv/graphql/schema.graphql lib/graphql/schema.graphql

# Run build_runner for code generation
RUN flutter pub run build_runner build --delete-conflicting-outputs

# Copy the test entrypoint script
COPY <<'EOF' /entrypoint.sh
#!/bin/bash
set -e

echo "============================================"
echo "Flutter E2E Integration Test Runner"
echo "============================================"
echo ""
echo "Configuration:"
echo "  CHROMEDRIVER_URL: ${CHROMEDRIVER_URL:-not set}"
echo "  MYDIA_URL: ${MYDIA_URL:-not set}"
echo "  RELAY_URL: ${RELAY_URL:-not set}"
echo ""

# Wait for Chrome to be ready
echo "Waiting for Selenium Chrome..."
max_attempts=30
attempt=0
while [ $attempt -lt $max_attempts ]; do
    if curl -sf "${CHROMEDRIVER_URL}/status" > /dev/null 2>&1; then
        echo "Selenium Chrome is ready!"
        break
    fi
    attempt=$((attempt + 1))
    echo "  Attempt $attempt/$max_attempts..."
    sleep 2
done

if [ $attempt -eq $max_attempts ]; then
    echo "ERROR: Selenium Chrome not available at ${CHROMEDRIVER_URL}"
    exit 1
fi

# Wait for Mydia to be ready
echo "Waiting for Mydia..."
attempt=0
while [ $attempt -lt $max_attempts ]; do
    if curl -sf "${MYDIA_URL}/health" > /dev/null 2>&1; then
        echo "Mydia is ready!"
        break
    fi
    attempt=$((attempt + 1))
    echo "  Attempt $attempt/$max_attempts..."
    sleep 2
done

if [ $attempt -eq $max_attempts ]; then
    echo "ERROR: Mydia not available at ${MYDIA_URL}"
    exit 1
fi

echo ""
echo "All services ready! Setting up WebDriver proxy..."
echo "============================================"
echo ""

# Set up port forwarding: localhost:4444 -> chrome:4444
# This allows flutter drive to connect to chromedriver as if it's local
socat TCP-LISTEN:4444,fork TCP:chrome:4444 &
SOCAT_PID=$!
echo "Port forwarding: localhost:4444 -> chrome:4444 (PID: $SOCAT_PID)"
sleep 1

# Verify the port forward is working
if curl -sf "http://localhost:4444/status" > /dev/null 2>&1; then
    echo "  ✓ Port forwarding verified"
else
    echo "WARNING: Port forward may not be working correctly"
fi

echo ""
echo "Running integration tests..."
echo ""

# Verify integration test files exist
if [ ! -f "integration_test/pairing_flow_test.dart" ]; then
    echo "ERROR: pairing_flow_test.dart not found!"
    exit 1
fi

echo "Found integration tests:"
ls -la integration_test/

# Create test driver (uses host network so localhost works for both)
mkdir -p test_driver
cat > test_driver/integration_test.dart << 'DART'
import 'package:integration_test/integration_test_driver.dart';

Future<void> main() {
  return integrationDriver();
}
DART

# Get the test container hostname for Chrome to reach our web server
TEST_HOST="${TEST_HOST:-test}"
WEB_PORT="${WEB_PORT:-4040}"

echo ""
echo "Setting up test environment..."
echo "  Mydia API: ${MYDIA_URL}"
echo "  Test Host: ${TEST_HOST}:${WEB_PORT}"
echo ""

# Login to Mydia and get auth token
echo "Logging in as test admin..."
LOGIN_RESPONSE=$(curl -sf "${MYDIA_URL}/api/graphql" \
    -H "Content-Type: application/json" \
    -d '{
        "query": "mutation Login($input: LoginInput!) { login(input: $input) { token } }",
        "variables": {
            "input": {
                "username": "'"${E2E_ADMIN_EMAIL:-admin@test.local}"'",
                "password": "'"${E2E_ADMIN_PASSWORD:-testpassword123}"'",
                "deviceId": "e2e-test-runner",
                "deviceName": "E2E Test Runner",
                "platform": "web"
            }
        }
    }' 2>&1)

AUTH_TOKEN=$(echo "$LOGIN_RESPONSE" | jq -r '.data.login.token // empty')

if [ -z "$AUTH_TOKEN" ]; then
    echo "ERROR: Failed to login to Mydia"
    echo "Response: $LOGIN_RESPONSE"
    exit 1
fi
echo "  ✓ Login successful"

# Generate a claim code
echo "Generating claim code..."
CLAIM_RESPONSE=$(curl -sf "${MYDIA_URL}/api/graphql" \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer $AUTH_TOKEN" \
    -d '{
        "query": "mutation { generateClaimCode { code expiresAt } }"
    }' 2>&1)

CLAIM_CODE=$(echo "$CLAIM_RESPONSE" | jq -r '.data.generateClaimCode.code // empty')

if [ -z "$CLAIM_CODE" ]; then
    echo "ERROR: Failed to generate claim code"
    echo "Response: $CLAIM_RESPONSE"
    exit 1
fi
echo "  ✓ Claim code generated: $CLAIM_CODE"

echo ""
echo "Running Flutter integration tests..."
echo "  WebDriver: localhost:4444 (proxied to chrome:4444)"
echo "  Test Web Server: http://${TEST_HOST}:${WEB_PORT}"
echo "  Claim Code: $CLAIM_CODE"
echo ""
echo "NOTE: Flutter's integration_test package hardcodes localhost URLs,"
echo "which means Chrome will try to navigate to localhost:${WEB_PORT}"
echo "instead of http://${TEST_HOST}:${WEB_PORT}. This is a known limitation."
echo ""

# Run Flutter integration tests
# - Uses 'web-server' device which serves the app and connects to WebDriver at localhost:4444
# - dart-define passes environment to the Flutter app at compile time
# - web-hostname=0.0.0.0 allows remote Chrome to connect back to our server

flutter drive \
    --driver=test_driver/integration_test.dart \
    --target=integration_test/pairing_flow_test.dart \
    -d web-server \
    --web-port=${WEB_PORT} \
    --web-hostname=0.0.0.0 \
    --dart-define=MYDIA_URL=${MYDIA_URL} \
    --dart-define=RELAY_URL=${RELAY_URL} \
    --dart-define=E2E_MODE=true \
    --dart-define=E2E_CLAIM_CODE=${CLAIM_CODE}

TEST_EXIT_CODE=$?

echo ""
echo "============================================"
if [ $TEST_EXIT_CODE -eq 0 ]; then
    echo "E2E Tests PASSED!"
else
    echo "E2E Tests FAILED! (exit code: $TEST_EXIT_CODE)"
fi
echo "============================================"

exit $TEST_EXIT_CODE
EOF

RUN chmod +x /entrypoint.sh

# Default command
ENTRYPOINT ["/entrypoint.sh"]
