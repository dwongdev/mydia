#!/usr/bin/env bash

# Dev command wrapper for docker compose management
# Provides convenient shortcuts for common development operations

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Configuration
COMPOSE_FILE="compose.yml"
SERVICE_NAME="app"

# Check if docker is available
if ! command -v docker &> /dev/null; then
    echo -e "${RED}Error: docker is not installed or not in PATH${NC}"
    echo "Please install Docker: https://docs.docker.com/get-docker/"
    exit 1
fi

# Check if docker compose is available
if ! docker compose version &> /dev/null; then
    echo -e "${RED}Error: docker compose is not available${NC}"
    echo "Please install Docker Compose: https://docs.docker.com/compose/install/"
    exit 1
fi

# Check if compose file exists
if [ ! -f "$COMPOSE_FILE" ]; then
    echo -e "${RED}Error: $COMPOSE_FILE not found${NC}"
    echo "Please run this script from the project root directory"
    exit 1
fi

# Show help if no arguments provided
if [ $# -eq 0 ]; then
    cat <<EOF
${GREEN}Mydia Development Helper${NC}

Usage: ./dev <command> [arguments...]

${YELLOW}Common Commands:${NC}
  up [-d]              Start services (add -d for detached mode)
  down                 Stop and remove containers
  restart              Restart services
  logs [-f] [service]  View logs (add -f to follow)
  ps                   List running containers
  stop                 Stop services
  start                Start services

${YELLOW}Container Commands:${NC}
  shell                Open an interactive shell in the app container
  mix <args>           Run mix commands inside the container
  iex                  Start IEx inside the container
  bash                 Open bash shell in the app container

${YELLOW}Development Commands:${NC}
  test [args]          Run tests (mix test)
  feature-test [args]  Run Wallaby browser tests
  format               Format code (mix format)
  deps.get             Install dependencies
  ecto.migrate         Run database migrations
  ecto.reset           Reset database
  phx.server           Start Phoenix server

${YELLOW}User Management:${NC}
  user list [--role=R] List all users (optionally filter by role)
  user add <email> <username> [opts]
                       Add a new user (--password, --role, --display-name)
  user delete <id>     Delete a user by email or username
  user reset-password <id> [--password=P]
                       Reset a user's password

${YELLOW}Player (Flutter in Docker):${NC}
  flutter <args>       Run any flutter command in Docker container
  player setup         Install deps and run code generation
  player build         Build and copy web assets to Phoenix
  player hot           Start player in hot restart mode (port 3000)
  player shell         Open shell in player container
  player logs          Follow player build output
  player restart       Restart player container
  player e2e           Run player E2E integration tests

${YELLOW}Player Development Modes:${NC}
  Default (watch): Rebuilds on file change, access at http://localhost:4000/player
  Hot restart:     Run './dev player hot' for instant updates at http://localhost:3000

${YELLOW}Docker Compose Commands:${NC}
  exec <service> <cmd> Execute command in running service
  run <service> <cmd>  Run one-off command in new container
  build [--no-cache]   Build or rebuild services
  pull                 Pull service images

${YELLOW}Examples:${NC}
  ./dev up -d                    # Start services in background
  ./dev logs -f                  # Follow logs
  ./dev shell                    # Open interactive shell
  ./dev mix test                 # Run tests
  ./dev feature-test             # Run Wallaby browser tests
  ./dev mix ecto.migrate         # Run migrations
  ./dev exec app mix phx.routes  # Show Phoenix routes
  ./dev user list                # List all users
  ./dev user add me@example.com myuser --password=secret123 --role=admin
  ./dev user reset-password admin --password=newpassword
  ./dev player hot               # Start Flutter with hot restart
  ./dev player build             # Build Flutter web assets for prod
  ./dev player logs              # Follow Flutter dev server logs

Any other command will be forwarded directly to docker compose.

EOF
    exit 0
fi

# Check if the app container is running
is_container_running() {
    docker compose ps --status=running --format '{{.Service}}' 2>/dev/null | grep -q "^${SERVICE_NAME}$"
}

# Helper function to run commands - uses exec if container is running, otherwise run
run_in_container() {
    if is_container_running; then
        # Use exec for faster execution when container is already running
        docker compose exec "$SERVICE_NAME" "$@"
    else
        # Use run for ephemeral containers when nothing is running
        docker compose run --rm "$SERVICE_NAME" "$@"
    fi
}

# Parse command
COMMAND=$1
shift

case "$COMMAND" in
    # Interactive shell shortcuts
    shell|sh)
        echo -e "${GREEN}Opening interactive shell in $SERVICE_NAME container...${NC}"
        run_in_container sh
        ;;

    bash)
        echo -e "${GREEN}Opening bash shell in $SERVICE_NAME container...${NC}"
        run_in_container bash
        ;;

    iex)
        echo -e "${GREEN}Starting IEx in $SERVICE_NAME container...${NC}"
        run_in_container iex -S mix
        ;;

    # Mix command shortcuts
    mix)
        # Set MIX_ENV=test for commands that run tests
        if [[ "$1" == "precommit" ]] || [[ "$1" == "test" ]]; then
            docker compose run --rm -e MIX_ENV=test "$SERVICE_NAME" mix "$@"
        else
            run_in_container mix "$@"
        fi
        ;;

    # Common development shortcuts
    test)
        echo -e "${GREEN}Running tests...${NC}"
        docker compose run --rm -e MIX_ENV=test "$SERVICE_NAME" sh -c 'mix ecto.create --quiet && mix ecto.migrate --quiet && mix test '"$*"
        ;;

    feature-test)
        echo -e "${GREEN}Running feature tests (Wallaby browser tests)...${NC}"
        docker compose run --rm -e MIX_ENV=test "$SERVICE_NAME" ./scripts/run-feature-tests.sh "$@"
        ;;

    format)
        echo -e "${GREEN}Formatting code...${NC}"
        run_in_container mix format
        ;;

    deps.get)
        echo -e "${GREEN}Installing dependencies...${NC}"
        run_in_container mix deps.get
        ;;

    ecto.migrate)
        echo -e "${GREEN}Running migrations...${NC}"
        run_in_container mix ecto.migrate
        ;;

    ecto.reset)
        echo -e "${GREEN}Resetting database...${NC}"
        run_in_container mix ecto.reset
        ;;

    phx.server)
        echo -e "${GREEN}Starting Phoenix server...${NC}"
        run_in_container mix phx.server
        ;;

    # User management
    user)
        if [ $# -eq 0 ]; then
            echo -e "${RED}Error: user command requires a subcommand${NC}"
            echo "Usage: ./dev user <list|add|delete|reset-password> [args...]"
            exit 1
        fi
        run_in_container mix mydia.user "$@"
        ;;

    # Flutter commands (runs in Docker container)
    flutter)
        echo -e "${GREEN}Running flutter command in Docker container...${NC}"
        docker compose exec player flutter "$@" || \
            docker compose run --rm player flutter "$@"
        ;;

    player)
        case "$1" in
            logs)
                echo -e "${GREEN}Following player build logs...${NC}"
                docker compose logs -f player
                ;;
            build)
                echo -e "${GREEN}Building player web assets...${NC}"
                docker compose exec player flutter build web --base-href /player/ || \
                    docker compose run --rm player flutter build web --base-href /player/
                echo -e "${GREEN}Copying assets to priv/static/player...${NC}"
                rm -rf priv/static/player
                mkdir -p priv/static/player
                cp -r player/build/web/* priv/static/player/
                echo -e "${GREEN}Player web assets built successfully!${NC}"
                ;;
            hot)
                echo -e "${GREEN}Starting player in hot restart mode...${NC}"
                # Stop existing player container if running
                docker compose stop player 2>/dev/null || true
                # Rebuild to ensure latest Dockerfile changes
                docker compose build player
                # Start with hot reload mode
                PLAYER_DEV_MODE=hot docker compose up player
                ;;
            setup)
                echo -e "${GREEN}Setting up player project (pub get + build_runner)...${NC}"
                docker compose exec player flutter pub get || \
                    docker compose run --rm player flutter pub get
                docker compose exec player flutter pub run build_runner build --delete-conflicting-outputs || \
                    docker compose run --rm player flutter pub run build_runner build --delete-conflicting-outputs
                echo -e "${GREEN}Player project setup complete!${NC}"
                ;;
            shell)
                echo -e "${GREEN}Opening shell in player container...${NC}"
                docker compose exec player bash || \
                    docker compose run --rm player bash
                ;;
            restart)
                echo -e "${GREEN}Restarting player dev server...${NC}"
                docker compose restart player
                echo -e "${GREEN}Player dev server restarted. Follow logs with: ./dev player logs${NC}"
                ;;
            e2e)
                echo -e "${GREEN}Running player E2E integration tests...${NC}"
                echo ""
                echo "This will:"
                echo "  1. Build and start metadata-relay"
                echo "  2. Build and start Mydia (E2E mode with test admin user)"
                echo "  3. Start Selenium Chrome for browser automation"
                echo "  4. Build Flutter web app and run integration tests"
                echo ""
                echo "Test flow: claim code → Noise handshake → device registration"
                echo ""
                # Build and run E2E tests
                docker compose -f compose.player-e2e.yml build
                docker compose -f compose.player-e2e.yml up --abort-on-container-exit --exit-code-from test
                exit_code=$?
                # Clean up
                docker compose -f compose.player-e2e.yml down -v
                exit $exit_code
                ;;
            *)
                echo -e "${RED}Error: Unknown player command: $1${NC}"
                echo "Usage: ./dev player <logs|build|hot|setup|shell|restart|e2e>"
                exit 1
                ;;
        esac
        ;;

    # Forward everything else to docker compose
    *)
        docker compose "$COMMAND" "$@"
        ;;
esac
