<Layouts.app {assigns}>
  <div class="container mx-auto px-4 py-8">
    <%!-- Page Header --%>
    <div class="mb-8 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h1 class="text-3xl font-bold flex items-center gap-3">
          <.icon name="hero-queue-list" class="w-8 h-8 text-primary" /> Import Lists
        </h1>
        <p class="text-base-content/70 mt-1">
          Automatically sync media from TMDB lists (trending, popular, upcoming, etc.)
        </p>
      </div>
      <div class="flex gap-2">
        <button phx-click="sync_all" class="btn btn-ghost btn-sm gap-2">
          <.icon name="hero-arrow-path" class="w-4 h-4" /> Sync All
        </button>
        <button phx-click="new_list" class="btn btn-primary btn-sm gap-2">
          <.icon name="hero-plus" class="w-4 h-4" /> New TMDB List
        </button>
      </div>
    </div>

    <%!-- Quick Add Presets Section (Compact) --%>
    <div class="mb-6 p-4 bg-base-200/50 rounded-xl">
      <div class="flex items-center gap-2 mb-3">
        <.icon name="hero-bolt" class="w-4 h-4 text-warning" />
        <span class="text-sm font-medium">Quick Add</span>
        <span class="text-xs text-base-content/50">— Enable popular TMDB lists</span>
      </div>
      <% available_presets =
        Enum.reject(@presets, fn p ->
          preset_configured?(@configured_presets, p.type, p.media_type)
        end) %>
      <%= if available_presets == [] do %>
        <p class="text-sm text-base-content/50">All presets enabled</p>
      <% else %>
        <div class="flex flex-wrap gap-2">
          <%= for preset <- available_presets do %>
            <button
              phx-click="enable_preset"
              phx-value-preset-id={preset.id}
              class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-base-100 border border-base-300 hover:border-primary hover:bg-primary/5 text-sm transition-colors"
              title={preset.description}
            >
              <.icon
                name={media_type_icon(preset.media_type)}
                class="w-3.5 h-3.5 text-base-content/60"
              />
              {preset.name}
              <.icon name="hero-plus" class="w-3 h-3 text-primary" />
            </button>
          <% end %>
        </div>
      <% end %>
    </div>

    <%!-- Active Lists Section --%>
    <div>
      <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
        <.icon name="hero-list-bullet" class="w-5 h-5 text-info" /> Active Lists
        <span class="badge badge-ghost">{length(@import_lists)}</span>
      </h2>

      <%= if @import_lists == [] do %>
        <div class="alert">
          <.icon name="hero-information-circle" class="w-5 h-5" />
          <span>No import lists configured. Enable a preset above or create a custom list.</span>
        </div>
      <% else %>
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
          <%= for list <- @import_lists do %>
            <% pending = pending_count(list) %>
            <div class={[
              "card bg-base-100 shadow-md hover:shadow-lg transition-shadow duration-200",
              !list.enabled && "opacity-50"
            ]}>
              <div class="card-body p-5">
                <%!-- Header: Name, Type, Toggle --%>
                <div class="flex items-start justify-between gap-3">
                  <div class="flex items-center gap-3 min-w-0">
                    <div class={[
                      "p-2 rounded-lg shrink-0",
                      if(list.media_type == "movie",
                        do: "bg-purple-500/10 text-purple-500",
                        else: "bg-blue-500/10 text-blue-500"
                      )
                    ]}>
                      <.icon name={media_type_icon(list.media_type)} class="w-5 h-5" />
                    </div>
                    <div class="min-w-0">
                      <h3 class="font-semibold truncate">{list.name}</h3>
                      <p class="text-xs text-base-content/50 truncate">
                        {ImportList.type_label(list.type)} · {if list.media_type == "movie",
                          do: "Movies",
                          else: "TV Shows"}
                      </p>
                    </div>
                  </div>
                  <input
                    type="checkbox"
                    class="toggle toggle-sm toggle-success shrink-0"
                    checked={list.enabled}
                    phx-click="toggle_list"
                    phx-value-id={list.id}
                    title={if list.enabled, do: "Disable", else: "Enable"}
                  />
                </div>

                <%!-- Stats Row --%>
                <div class="flex flex-wrap items-center gap-3 mt-3 text-sm">
                  <div class="flex items-center gap-1.5 text-base-content/60">
                    <.icon name="hero-clock" class="w-4 h-4" />
                    <span>{ImportList.sync_interval_label(list.sync_interval)}</span>
                  </div>
                  <span class="text-base-content/30">·</span>
                  <span class={
                    if(list.sync_error, do: "text-error", else: "text-base-content/60")
                  }>
                    {format_last_synced(list.last_synced_at)}
                    <%= if list.sync_error do %>
                      <span class="tooltip tooltip-error cursor-help" data-tip={list.sync_error}>
                        <.icon
                          name="hero-exclamation-circle"
                          class="w-4 h-4 text-error inline ml-1"
                        />
                      </span>
                    <% end %>
                  </span>
                </div>

                <%!-- Badges --%>
                <div class="flex flex-wrap gap-2 mt-2">
                  <%= if list.auto_add do %>
                    <span class="badge badge-info badge-sm gap-1">
                      <.icon name="hero-bolt" class="w-3 h-3" /> Auto-add
                    </span>
                  <% end %>
                  <button
                    phx-click="view_items"
                    phx-value-id={list.id}
                    class="badge badge-ghost badge-sm gap-1 hover:badge-primary cursor-pointer"
                  >
                    <.icon name="hero-queue-list" class="w-3 h-3" />
                    {item_count_badge(list)}
                  </button>
                  <%= if pending > 0 and not list.auto_add do %>
                    <button
                      phx-click="add_pending_from_table"
                      phx-value-id={list.id}
                      class="badge badge-warning badge-sm gap-1 hover:brightness-110 cursor-pointer"
                      title={"Add #{pending} pending items to library"}
                    >
                      <.icon name="hero-plus" class="w-3 h-3" />
                      {pending} pending
                    </button>
                  <% end %>
                </div>

                <%!-- Actions --%>
                <div class="card-actions justify-end mt-3 pt-3 border-t border-base-200">
                  <button
                    phx-click="sync_list"
                    phx-value-id={list.id}
                    class="btn btn-ghost btn-sm gap-1"
                    disabled={@syncing_list_id == list.id}
                  >
                    <%= if @syncing_list_id == list.id do %>
                      <.icon name="hero-arrow-path" class="w-4 h-4 animate-spin" />
                    <% else %>
                      <.icon name="hero-arrow-path" class="w-4 h-4" />
                    <% end %>
                    Sync
                  </button>
                  <button
                    phx-click="edit_list"
                    phx-value-id={list.id}
                    class="btn btn-ghost btn-sm gap-1"
                  >
                    <.icon name="hero-pencil" class="w-4 h-4" /> Edit
                  </button>
                  <button
                    phx-click="delete_list"
                    phx-value-id={list.id}
                    class="btn btn-ghost btn-sm text-error"
                    data-confirm="Are you sure you want to delete this import list?"
                  >
                    <.icon name="hero-trash" class="w-4 h-4" />
                  </button>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <%!-- List Edit/Create Modal --%>
  <%= if @show_list_modal do %>
    <div class="modal modal-open">
      <div class="modal-box max-w-lg">
        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
          <.icon name="hero-queue-list" class="w-5 h-5 text-primary" />
          {if @list_mode == :new, do: "Create Import List", else: "Edit Import List"}
        </h3>

        <.form for={@form} id="import-list-form" phx-change="validate_list" phx-submit="save_list">
          <div class="space-y-4">
            <.input field={@form[:name]} type="text" label="Name" required />

            <%= if @list_mode == :new do %>
              <.input
                field={@form[:type]}
                type="select"
                label="List Source"
                options={[
                  {"-- TMDB Preset Lists --", ""},
                  {"Trending", "tmdb_trending"},
                  {"Popular", "tmdb_popular"},
                  {"Upcoming (Movies)", "tmdb_upcoming"},
                  {"Now Playing (Movies)", "tmdb_now_playing"},
                  {"On The Air (TV)", "tmdb_on_the_air"},
                  {"Airing Today (TV)", "tmdb_airing_today"},
                  {"-- Custom Lists --", ""},
                  {"TMDB User List", "tmdb_list"},
                  {"Custom URL (JSON)", "custom_url"}
                ]}
                required
              />

              <% selected_type = Phoenix.HTML.Form.input_value(@form, :type) %>

              <%= if ImportList.requires_config?(selected_type) do %>
                <.input
                  field={@form[:list_url]}
                  type="text"
                  label={ImportList.config_field_label(selected_type)}
                  placeholder={ImportList.config_field_placeholder(selected_type)}
                  required
                />
              <% end %>

              <.input
                field={@form[:media_type]}
                type="select"
                label="Media Type"
                options={[{"Movies", "movie"}, {"TV Shows", "tv_show"}]}
                required
              />
            <% else %>
              <div class="form-control">
                <label class="label">
                  <span class="label-text">List Type</span>
                </label>
                <input
                  type="text"
                  value={ImportList.type_label(@selected_list.type)}
                  class="input input-bordered"
                  disabled
                />
              </div>

              <%= if ImportList.requires_config?(@selected_list.type) do %>
                <.input
                  field={@form[:list_url]}
                  type="text"
                  label={ImportList.config_field_label(@selected_list.type)}
                  placeholder={ImportList.config_field_placeholder(@selected_list.type)}
                  value={@selected_list.config["list_url"]}
                />
              <% end %>

              <div class="form-control">
                <label class="label">
                  <span class="label-text">Media Type</span>
                </label>
                <input
                  type="text"
                  value={if @selected_list.media_type == "movie", do: "Movies", else: "TV Shows"}
                  class="input input-bordered"
                  disabled
                />
              </div>
            <% end %>

            <.input
              field={@form[:sync_interval]}
              type="select"
              label="Sync Interval"
              options={[
                {"Every hour", 60},
                {"Every 6 hours", 360},
                {"Every 12 hours", 720},
                {"Every 24 hours", 1440}
              ]}
            />

            <.input
              field={@form[:quality_profile_id]}
              type="select"
              label="Quality Profile (Optional)"
              options={[{"Default", nil}] ++ Enum.map(@quality_profiles, &{&1.name, &1.id})}
              prompt="Select quality profile..."
            />

            <.input
              field={@form[:library_path_id]}
              type="select"
              label="Library Path (Optional)"
              options={[{"Default", nil}] ++ Enum.map(@library_paths, &{&1.path, &1.id})}
              prompt="Select library path..."
            />

            <div class="divider text-sm text-base-content/60">Behavior</div>

            <div class="flex flex-col gap-3">
              <label class="flex items-center gap-3 cursor-pointer">
                <input
                  type="checkbox"
                  name={@form[:auto_add].name}
                  value="true"
                  checked={Phoenix.HTML.Form.normalize_value("checkbox", @form[:auto_add].value)}
                  class="checkbox checkbox-primary checkbox-sm"
                />
                <div>
                  <span class="font-medium">Auto-add to library</span>
                  <p class="text-xs text-base-content/60">
                    Automatically add new items without manual approval
                  </p>
                </div>
              </label>

              <label class="flex items-center gap-3 cursor-pointer">
                <input
                  type="checkbox"
                  name={@form[:monitored].name}
                  value="true"
                  checked={Phoenix.HTML.Form.normalize_value("checkbox", @form[:monitored].value)}
                  class="checkbox checkbox-primary checkbox-sm"
                />
                <div>
                  <span class="font-medium">Monitor new items</span>
                  <p class="text-xs text-base-content/60">
                    Automatically search for downloads when items are added
                  </p>
                </div>
              </label>

              <label class="flex items-center gap-3 cursor-pointer">
                <input
                  type="checkbox"
                  name={@form[:enabled].name}
                  value="true"
                  checked={Phoenix.HTML.Form.normalize_value("checkbox", @form[:enabled].value)}
                  class="checkbox checkbox-success checkbox-sm"
                />
                <div>
                  <span class="font-medium">Enabled</span>
                  <p class="text-xs text-base-content/60">Enable automatic syncing</p>
                </div>
              </label>
            </div>
          </div>

          <div class="modal-action">
            <button type="button" phx-click="close_list_modal" class="btn btn-ghost">
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">
              {if @list_mode == :new, do: "Create", else: "Save"}
            </button>
          </div>
        </.form>
      </div>
      <div class="modal-backdrop" phx-click="close_list_modal"></div>
    </div>
  <% end %>

  <%!-- Preset Enable Confirmation Modal --%>
  <%= if @show_preset_confirm_modal and @pending_preset_id do %>
    <div class="modal modal-open">
      <div class="modal-box max-w-md">
        <h3 class="font-bold text-lg mb-2 flex items-center gap-2">
          <.icon name="hero-question-mark-circle" class="w-6 h-6 text-primary" />
          Enable {get_preset_name(@pending_preset_id)}?
        </h3>

        <p class="text-base-content/70 mb-6">
          How would you like to handle new items from this list?
        </p>

        <div class="space-y-4">
          <div class="card bg-base-200 cursor-pointer hover:bg-base-300 transition-colors">
            <button
              phx-click="confirm_enable_preset"
              phx-value-auto-add="true"
              class="card-body p-4 text-left w-full"
            >
              <div class="flex items-start gap-3">
                <.icon name="hero-bolt" class="w-6 h-6 text-warning flex-shrink-0 mt-0.5" />
                <div>
                  <h4 class="font-semibold">Yes, auto-add new items</h4>
                  <p class="text-sm text-base-content/60 mt-1">
                    New items will be automatically added to your library when synced.
                    Good if you trust this list's selections.
                  </p>
                </div>
              </div>
            </button>
          </div>

          <div class="card bg-base-200 cursor-pointer hover:bg-base-300 transition-colors">
            <button
              phx-click="confirm_enable_preset"
              phx-value-auto-add="false"
              class="card-body p-4 text-left w-full"
            >
              <div class="flex items-start gap-3">
                <.icon name="hero-eye" class="w-6 h-6 text-info flex-shrink-0 mt-0.5" />
                <div>
                  <h4 class="font-semibold">No, I'll review first</h4>
                  <p class="text-sm text-base-content/60 mt-1">
                    Items will be marked as "pending" and you can add them manually.
                    Best for discovering new content at your own pace.
                  </p>
                </div>
              </div>
            </button>
          </div>
        </div>

        <div class="modal-action">
          <button phx-click="close_preset_confirm_modal" class="btn btn-ghost">
            Cancel
          </button>
        </div>
      </div>
      <div class="modal-backdrop" phx-click="close_preset_confirm_modal"></div>
    </div>
  <% end %>

  <%!-- Items Preview Modal --%>
  <%= if @show_items_modal and @selected_list do %>
    <div class="modal modal-open">
      <div class="modal-box max-w-4xl max-h-[80vh]">
        <h3 class="font-bold text-lg mb-2 flex items-center gap-2">
          <.icon name={media_type_icon(@selected_list.media_type)} class="w-5 h-5 text-primary" />
          {@selected_list.name} - Items
        </h3>

        <%!-- Status Legend --%>
        <div class="flex flex-wrap gap-2 mb-4 text-xs">
          <div class="flex items-center gap-1">
            <span class="badge badge-warning badge-xs"></span>
            <span class="text-base-content/60">Pending = Waiting to add</span>
          </div>
          <div class="flex items-center gap-1">
            <span class="badge badge-success badge-xs"></span>
            <span class="text-base-content/60">Added = In library</span>
          </div>
          <div class="flex items-center gap-1">
            <span class="badge badge-ghost badge-xs"></span>
            <span class="text-base-content/60">Skipped = Already exists</span>
          </div>
          <div class="flex items-center gap-1">
            <span class="badge badge-error badge-xs"></span>
            <span class="text-base-content/60">Failed = Error occurred</span>
          </div>
        </div>

        <%!-- Filter Tabs and Bulk Actions --%>
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-4">
          <div role="tablist" class="tabs tabs-boxed">
            <button
              role="tab"
              class={["tab tab-sm", @items_filter == "all" && "tab-active"]}
              phx-click="filter_items"
              phx-value-status="all"
            >
              All
            </button>
            <button
              role="tab"
              class={["tab tab-sm", @items_filter == "pending" && "tab-active"]}
              phx-click="filter_items"
              phx-value-status="pending"
            >
              Pending
            </button>
            <button
              role="tab"
              class={["tab tab-sm", @items_filter == "added" && "tab-active"]}
              phx-click="filter_items"
              phx-value-status="added"
            >
              Added
            </button>
            <button
              role="tab"
              class={["tab tab-sm", @items_filter == "skipped" && "tab-active"]}
              phx-click="filter_items"
              phx-value-status="skipped"
            >
              Skipped
            </button>
          </div>

          <%= if pending_items_in_list?(@items) do %>
            <button
              phx-click="add_all_pending"
              class="btn btn-primary btn-sm gap-1"
            >
              <.icon name="hero-plus" class="w-4 h-4" /> Add All Pending to Library
            </button>
          <% end %>
        </div>

        <%!-- Items Grid --%>
        <%= if @items == [] do %>
          <div class="alert">
            <.icon name="hero-information-circle" class="w-5 h-5" />
            <span>
              No items found. {if @items_filter != "all",
                do: "Try a different filter or ",
                else: ""}Sync the list to fetch items.
            </span>
          </div>
        <% else %>
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 overflow-y-auto max-h-[50vh]">
            <%= for item <- group_items_by_status(@items) do %>
              <div class="card bg-base-200 shadow-sm">
                <figure class="relative">
                  <%= if item.poster_path do %>
                    <img
                      src={"https://image.tmdb.org/t/p/w185#{item.poster_path}"}
                      alt={item.title}
                      class="w-full aspect-[2/3] object-cover"
                      loading="lazy"
                    />
                  <% else %>
                    <div class="w-full aspect-[2/3] bg-base-300 flex items-center justify-center">
                      <.icon
                        name={media_type_icon(@selected_list.media_type)}
                        class="w-12 h-12 text-base-content/30"
                      />
                    </div>
                  <% end %>
                  <% effective_status = display_status(item) %>
                  <div class="absolute top-1 right-1">
                    <span
                      class={[
                        "badge badge-sm tooltip tooltip-left",
                        status_badge_class(effective_status)
                      ]}
                      data-tip={status_explanation(effective_status)}
                    >
                      {effective_status}
                    </span>
                  </div>
                </figure>
                <div class="card-body p-2">
                  <h4 class="font-medium text-xs line-clamp-2" title={item.title}>
                    {item.title}
                  </h4>
                  <p class="text-xs text-base-content/60">
                    {item.year || "Unknown year"}
                  </p>
                  <%= if effective_status == "skipped" and item.skip_reason do %>
                    <p class="text-xs text-warning truncate" title={item.skip_reason}>
                      {item.skip_reason}
                    </p>
                  <% end %>
                  <%= if effective_status == "failed" and item.skip_reason do %>
                    <p class="text-xs text-error truncate" title={item.skip_reason}>
                      {item.skip_reason}
                    </p>
                  <% end %>
                  <div class="flex gap-1 mt-1">
                    <%= if effective_status == "pending" do %>
                      <button
                        phx-click="add_item_to_library"
                        phx-value-id={item.id}
                        class="btn btn-primary btn-xs flex-1 gap-1"
                      >
                        <.icon name="hero-plus" class="w-3 h-3" /> Add
                      </button>
                    <% end %>
                    <%= if effective_status in ["skipped", "failed"] do %>
                      <button
                        phx-click="reset_item"
                        phx-value-id={item.id}
                        class="btn btn-ghost btn-xs flex-1"
                      >
                        Reset
                      </button>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>

        <div class="modal-action">
          <button phx-click="close_items_modal" class="btn btn-ghost">Close</button>
          <button phx-click="sync_list" phx-value-id={@selected_list.id} class="btn btn-primary">
            <.icon name="hero-arrow-path" class="w-4 h-4" /> Sync Now
          </button>
        </div>
      </div>
      <div class="modal-backdrop" phx-click="close_items_modal"></div>
    </div>
  <% end %>
</Layouts.app>
