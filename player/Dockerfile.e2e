# syntax=docker/dockerfile:1.4
# ============================================
# E2E Test Build - Flutter Web Player
# ============================================
# This Dockerfile builds the Flutter web player for E2E testing.
# It bakes in the relay URL at build time using --dart-define.
# The built app is served via nginx for standalone testing.
#
# NOTE: This Dockerfile expects the build context to be the project root
# (not the player directory) so it can access priv/graphql/schema.graphql
#
# Build with: DOCKER_BUILDKIT=1 docker build -f player/Dockerfile.e2e .

# ============================================
# Build Stage
# ============================================
FROM ghcr.io/cirruslabs/flutter:stable AS builder

# Build arguments for compile-time configuration
ARG RELAY_URL=http://localhost:4001
ARG MYDIA_URL=http://localhost:4000

# Set pub cache location for caching
ENV PUB_CACHE=/root/.pub-cache

WORKDIR /app

# Copy pubspec files first for better caching
COPY player/pubspec.yaml player/pubspec.lock ./

# Install dependencies with cache
RUN --mount=type=cache,target=/root/.pub-cache \
    flutter pub get && \
    cp -r /root/.pub-cache /tmp/.pub-cache-copy

# Copy the rest of the player app
COPY player/ .

# Remove the broken symlink and copy the actual schema file
RUN rm -f lib/graphql/schema.graphql
COPY priv/graphql/schema.graphql lib/graphql/schema.graphql

# Run build_runner for code generation with cache
RUN --mount=type=cache,target=/root/.pub-cache \
    cp -r /tmp/.pub-cache-copy/* /root/.pub-cache/ 2>/dev/null || true && \
    flutter pub run build_runner build --delete-conflicting-outputs

# Build Flutter web with environment variables baked in
RUN --mount=type=cache,target=/root/.pub-cache \
    flutter build web \
    --release \
    --tree-shake-icons \
    --dart-define=RELAY_URL=${RELAY_URL} \
    --dart-define=MYDIA_URL=${MYDIA_URL} \
    --dart-define=E2E_MODE=true

# ============================================
# Runtime Stage - nginx
# ============================================
FROM nginx:alpine

# Copy the built Flutter web app
COPY --from=builder /app/build/web /usr/share/nginx/html

# Custom nginx config for SPA routing
COPY <<'EOF' /etc/nginx/conf.d/default.conf
server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    # Enable gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

    # Handle SPA routing - serve index.html for all routes
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Cache static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 1d;
        add_header Cache-Control "public, immutable";
    }

    # Health check endpoint
    location /health {
        return 200 'OK';
        add_header Content-Type text/plain;
    }
}
EOF

EXPOSE 80

HEALTHCHECK --interval=5s --timeout=3s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:80/health || exit 1

CMD ["nginx", "-g", "daemon off;"]
