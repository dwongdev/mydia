name: Player Build (Desktop)

on:
  push:
    branches:
      - master
      - main
    paths:
      - "player/**"
      - ".github/workflows/player-build.yml"
  pull_request:
    paths:
      - "player/**"
      - ".github/workflows/player-build.yml"
  workflow_dispatch:

env:
  PLAYER_PATH: 'player'

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for Windows platform support
        id: check_windows
        shell: bash
        run: |
          if [ -d "${{ env.PLAYER_PATH }}/windows" ]; then
            echo "enabled=true" >> $GITHUB_OUTPUT
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
            echo "::warning::Windows platform not configured yet. Skipping build."
          fi

      - name: Setup Flutter
        if: steps.check_windows.outputs.enabled == 'true'
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        if: steps.check_windows.outputs.enabled == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~\.pub-cache
            ${{ env.PLAYER_PATH }}\.dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Install dependencies
        if: steps.check_windows.outputs.enabled == 'true'
        working-directory: ${{ env.PLAYER_PATH }}
        run: flutter pub get

      - name: Run code generation
        if: steps.check_windows.outputs.enabled == 'true'
        working-directory: ${{ env.PLAYER_PATH }}
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Generate icons
        if: steps.check_windows.outputs.enabled == 'true'
        working-directory: ${{ env.PLAYER_PATH }}
        run: dart run flutter_launcher_icons

      - name: Build Windows release
        if: steps.check_windows.outputs.enabled == 'true'
        working-directory: ${{ env.PLAYER_PATH }}
        run: flutter build windows --release

      - name: Upload Windows build artifact
        if: steps.check_windows.outputs.enabled == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: player-windows-release
          path: ${{ env.PLAYER_PATH }}/build/windows/x64/runner/Release/
          retention-days: 7

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for macOS platform support
        id: check_macos
        run: |
          if [ -d "${{ env.PLAYER_PATH }}/macos" ]; then
            echo "enabled=true" >> $GITHUB_OUTPUT
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
            echo "::warning::macOS platform not configured yet. Skipping build."
          fi

      - name: Setup Flutter
        if: steps.check_macos.outputs.enabled == 'true'
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        if: steps.check_macos.outputs.enabled == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ env.PLAYER_PATH }}/.dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Install dependencies
        if: steps.check_macos.outputs.enabled == 'true'
        working-directory: ${{ env.PLAYER_PATH }}
        run: flutter pub get

      - name: Run code generation
        if: steps.check_macos.outputs.enabled == 'true'
        working-directory: ${{ env.PLAYER_PATH }}
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Build macOS release
        if: steps.check_macos.outputs.enabled == 'true'
        working-directory: ${{ env.PLAYER_PATH }}
        run: flutter build macos --release

      - name: Upload macOS build artifact
        if: steps.check_macos.outputs.enabled == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: player-macos-app
          path: ${{ env.PLAYER_PATH }}/build/macos/Build/Products/Release/Mydia.app
          retention-days: 7

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for Linux platform support
        id: check_linux
        run: |
          if [ -d "${{ env.PLAYER_PATH }}/linux" ]; then
            echo "enabled=true" >> $GITHUB_OUTPUT
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
            echo "::warning::Linux platform not configured yet. Skipping build."
          fi

      - name: Install Linux dependencies
        if: steps.check_linux.outputs.enabled == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            liblzma-dev \
            libmpv-dev \
            libsecret-1-dev

      - name: Setup Flutter
        if: steps.check_linux.outputs.enabled == 'true'
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        if: steps.check_linux.outputs.enabled == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ env.PLAYER_PATH }}/.dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Install dependencies
        if: steps.check_linux.outputs.enabled == 'true'
        working-directory: ${{ env.PLAYER_PATH }}
        run: flutter pub get

      - name: Run code generation
        if: steps.check_linux.outputs.enabled == 'true'
        working-directory: ${{ env.PLAYER_PATH }}
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Build Linux release
        if: steps.check_linux.outputs.enabled == 'true'
        working-directory: ${{ env.PLAYER_PATH }}
        run: flutter build linux --release

      - name: Upload Linux build artifact
        if: steps.check_linux.outputs.enabled == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: player-linux-bundle
          path: ${{ env.PLAYER_PATH }}/build/linux/x64/release/bundle
          retention-days: 7
