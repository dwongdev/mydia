services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: mydia_dev
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    profiles:
      - postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  app:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: mydia_dev
    environment:
      # Phoenix configuration
      PHX_HOST: localhost
      PORT: 4000
      SECRET_KEY_BASE: "VlPUd2fbnWjh6Di+7SGc2SSXpNhI0hN766FFAlct65wU5ARyiGvK9r3TqSqKyu0K"

      # Database configuration (SQLite)
      DATABASE_PATH: /app/mydia_dev.db

      # Mix environment
      MIX_ENV: dev

      # Metadata relay configuration
      METADATA_RELAY_URL: ${METADATA_RELAY_URL:-https://metadata-relay.arsfeld.dev}

      # For interactive debugging
      MIX_HOME: /app/.mix
      HEX_HOME: /app/.hex
    ports:
      - "4000:4000"
    volumes:
      # Mount source code for live reloading
      - .:/app

      # Persist build artifacts and dependencies across restarts
      - build_cache:/app/_build
      - deps_cache:/app/deps
      - mix_cache:/app/.mix
      - hex_cache:/app/.hex
      - node_modules:/app/assets/node_modules
      # Persist NIF cache to avoid redownloading/recompiling on every run
      - elixir_make_cache:/root/.cache/elixir_make
    stdin_open: true
    tty: true
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000"]
      interval: 30s
      timeout: 3s
      start_period: 40s
      retries: 3

  flutter:
    image: ghcr.io/cirruslabs/flutter:stable
    container_name: mydia_flutter
    working_dir: /app/clients/player
    environment:
      PUB_CACHE: /app/clients/player/.pub-cache
    volumes:
      - .:/app
      - flutter_pub_cache:/app/clients/player/.pub-cache
    ports:
      - "3000:3000"
    # Flutter web dev with file watching, auto-rebuild, and live reload
    command: ["bash", "-c", "set -e; apt-get update -qq && apt-get install -y -qq inotify-tools > /dev/null 2>&1; flutter pub get; echo 'Initial Flutter web build...'; flutter build web --profile --dart-define=Dart2jsOptimization=O0 --base-href /player/ 2>&1; RELOAD_TRIGGER=/tmp/reload_trigger; echo 0 > $$RELOAD_TRIGGER; inject_livereload() { if [ -f build/web/index.html ]; then sed -i 's|</body>|<script>(function(){var es=new EventSource(\"http://\"+location.hostname+\":3000/livereload\");es.onmessage=function(){location.reload()};es.onerror=function(){es.close()}})();</script></body>|' build/web/index.html; fi; }; sync_to_phoenix() { rm -rf /app/priv/static/player && mkdir -p /app/priv/static/player && cp -r build/web/* /app/priv/static/player/; }; inject_livereload; sync_to_phoenix; python3 scripts/livereload_server.py & sleep 2; echo ''; echo '================================================='; echo 'Flutter dev server ready with LIVE RELOAD!'; echo 'Edit files and browser will refresh automatically'; echo 'Files synced to priv/static/player/'; echo '================================================='; echo ''; while true; do inotifywait -r -e modify,create,delete --exclude '\\.dart_tool|build|\\.git' lib/ 2>/dev/null; echo ''; echo '>>> File change detected, rebuilding...'; if flutter build web --profile --dart-define=Dart2jsOptimization=O0 --base-href /player/ 2>&1; then inject_livereload; sync_to_phoenix; echo '>>> Build complete! Synced to Phoenix. Reloading browser...'; date +%s > $$RELOAD_TRIGGER; else echo '>>> Build FAILED - check errors above'; fi; done"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 3s
      start_period: 120s
      retries: 3

volumes:
  flutter_pub_cache:
    driver: local
  # Named volumes for caching
  build_cache:
    driver: local
  deps_cache:
    driver: local
  mix_cache:
    driver: local
  hex_cache:
    driver: local
  node_modules:
    driver: local
  elixir_make_cache:
    driver: local
  # PostgreSQL data (only used with --profile postgres)
  postgres_data:
    driver: local
