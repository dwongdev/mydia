FROM ghcr.io/cirruslabs/flutter:stable

# Install development dependencies
RUN apt-get update -qq && \
    apt-get install -y -qq --no-install-recommends \
        curl \
    && rm -rf /var/lib/apt/lists/*

# Pre-configure Flutter
RUN flutter config --no-analytics

WORKDIR /app/player

# Create entrypoint script
COPY <<'EOF' /entrypoint.sh
#!/bin/bash
set -e

cd /app/player

# Install dependencies
flutter pub get

# Run build_runner for code generation if needed
if [ -f "lib/graphql/schema.graphql.dart" ]; then
    echo "GraphQL codegen already exists, skipping build_runner..."
else
    echo "Running build_runner for code generation..."
    flutter pub run build_runner build --delete-conflicting-outputs || true
fi

echo ''
echo '================================================='
echo 'Flutter Web Development Server'
echo '================================================='
echo ''
echo 'Access the player at: http://localhost:4000/player'
echo ''
echo 'Hot restart: Press "R" in this terminal'
echo 'Hot reload:  Press "r" in this terminal'
echo ''
echo '================================================='
echo ''

# Run Flutter web server
# Phoenix will reverse-proxy to this server
exec flutter run -d web-server \
    --web-port=3000 \
    --web-hostname=0.0.0.0
EOF

RUN chmod +x /entrypoint.sh

EXPOSE 3000

CMD ["/entrypoint.sh"]
