# syntax=docker/dockerfile:1.4
# ============================================
# E2E Test Runner - Flutter Integration Tests
# ============================================
# This Dockerfile runs Flutter integration tests using `flutter drive` with ChromeDriver.
#
# How it works:
# 1. Chrome and ChromeDriver are installed in this container
# 2. ChromeDriver is started in the background on port 4444
# 3. `flutter drive` launches the app and runs tests against it
# 4. Tests run against real Mydia and Relay services on the e2e network
#
# NOTE: This Dockerfile expects the build context to be the project root
# (not the player directory) so it can access priv/graphql/schema.graphql
#
# Build with: DOCKER_BUILDKIT=1 docker build -f player/Dockerfile.test .
#
# Environment variables required:
# - MYDIA_URL: URL of the Mydia server (for API calls)
# - RELAY_URL: URL of the metadata-relay service

FROM ghcr.io/cirruslabs/flutter:stable

# Set pub cache location for caching
ENV PUB_CACHE=/root/.pub-cache

# Install Chrome, ChromeDriver and additional dependencies
RUN apt-get update -qq && \
    apt-get install -y -qq --no-install-recommends \
        curl \
        jq \
        wget \
        gnupg \
        ca-certificates \
        unzip \
    && wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg \
    && echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list \
    && apt-get update -qq \
    && apt-get install -y -qq --no-install-recommends google-chrome-stable \
    && rm -rf /var/lib/apt/lists/*

# Install ChromeDriver that matches Chrome version
RUN CHROME_VERSION=$(google-chrome-stable --version | awk '{print $3}' | cut -d. -f1) && \
    echo "Chrome major version: $CHROME_VERSION" && \
    CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_$CHROME_VERSION") && \
    echo "ChromeDriver version: $CHROMEDRIVER_VERSION" && \
    wget -q "https://storage.googleapis.com/chrome-for-testing-public/${CHROMEDRIVER_VERSION}/linux64/chromedriver-linux64.zip" -O /tmp/chromedriver.zip && \
    unzip -q /tmp/chromedriver.zip -d /tmp && \
    mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/ && \
    chmod +x /usr/local/bin/chromedriver && \
    rm -rf /tmp/chromedriver* && \
    chromedriver --version

# Set Chrome as the default browser for Flutter
ENV CHROME_EXECUTABLE=/usr/bin/google-chrome-stable

WORKDIR /app

# Copy pubspec files first for better caching
COPY player/pubspec.yaml player/pubspec.lock ./

# Install dependencies with cache
RUN --mount=type=cache,target=/root/.pub-cache \
    flutter pub get && \
    cp -r /root/.pub-cache /tmp/.pub-cache-copy

# Copy the rest of the player app
COPY player/ .

# Remove the broken symlink and copy the actual schema file
RUN rm -f lib/graphql/schema.graphql
COPY priv/graphql/schema.graphql lib/graphql/schema.graphql

# Run build_runner for code generation with cache
RUN --mount=type=cache,target=/root/.pub-cache \
    cp -r /tmp/.pub-cache-copy/* /root/.pub-cache/ 2>/dev/null || true && \
    flutter pub run build_runner build --delete-conflicting-outputs

# Copy the test entrypoint script
COPY <<'EOF' /entrypoint.sh
#!/bin/bash
set -e

echo "============================================"
echo "Flutter E2E Integration Test Runner"
echo "============================================"
echo ""
echo "Configuration:"
echo "  MYDIA_URL: ${MYDIA_URL:-not set}"
echo "  RELAY_URL: ${RELAY_URL:-not set}"
echo "  Chrome: $(google-chrome-stable --version)"
echo "  ChromeDriver: $(chromedriver --version)"
echo ""

# Wait for Mydia to be ready and resolve its IP for Chrome
echo "Waiting for Mydia..."
max_attempts=30
attempt=0
while [ $attempt -lt $max_attempts ]; do
    if curl -sf "${MYDIA_URL}/health" > /dev/null 2>&1; then
        echo "  ✓ Mydia is ready!"
        break
    fi
    attempt=$((attempt + 1))
    echo "  Attempt $attempt/$max_attempts..."
    sleep 2
done

if [ $attempt -eq $max_attempts ]; then
    echo "ERROR: Mydia not available at ${MYDIA_URL}"
    exit 1
fi

# Get Mydia IP for Chrome (Chrome may not use Docker DNS)
MYDIA_HOST=$(echo "${MYDIA_URL}" | sed -E 's|https?://([^:/]+).*|\1|')
MYDIA_PORT=$(echo "${MYDIA_URL}" | sed -E 's|https?://[^:]+:([0-9]+).*|\1|')
MYDIA_IP=$(getent hosts "${MYDIA_HOST}" 2>/dev/null | awk '{print $1}')
if [ -n "$MYDIA_IP" ]; then
    echo "  Resolved ${MYDIA_HOST} to ${MYDIA_IP}"
    RESOLVED_MYDIA_URL="http://${MYDIA_IP}:${MYDIA_PORT}"
    echo "  Using resolved URL: ${RESOLVED_MYDIA_URL}"
else
    echo "  Warning: Could not resolve ${MYDIA_HOST}, using original URL"
    RESOLVED_MYDIA_URL="${MYDIA_URL}"
fi

# Wait for Relay to be ready and resolve its IP for Chrome
echo ""
echo "Waiting for Relay..."
attempt=0
while [ $attempt -lt $max_attempts ]; do
    if curl -sf "${RELAY_URL}/health" > /dev/null 2>&1; then
        echo "  ✓ Relay is ready!"
        break
    fi
    attempt=$((attempt + 1))
    echo "  Attempt $attempt/$max_attempts..."
    sleep 2
done

if [ $attempt -eq $max_attempts ]; then
    echo "ERROR: Relay not available at ${RELAY_URL}"
    exit 1
fi

# Get relay IP for Chrome (Chrome may not use Docker DNS)
RELAY_HOST=$(echo "${RELAY_URL}" | sed -E 's|https?://([^:/]+).*|\1|')
RELAY_PORT=$(echo "${RELAY_URL}" | sed -E 's|https?://[^:]+:([0-9]+).*|\1|')
RELAY_IP=$(getent hosts "${RELAY_HOST}" 2>/dev/null | awk '{print $1}')
if [ -n "$RELAY_IP" ]; then
    echo "  Resolved ${RELAY_HOST} to ${RELAY_IP}"
    RESOLVED_RELAY_URL="http://${RELAY_IP}:${RELAY_PORT}"
    echo "  Using resolved URL: ${RESOLVED_RELAY_URL}"
else
    echo "  Warning: Could not resolve ${RELAY_HOST}, using original URL"
    RESOLVED_RELAY_URL="${RELAY_URL}"
fi

echo ""
echo "All services ready!"
echo "============================================"
echo ""

# Verify integration test files exist
if [ ! -f "integration_test/pairing_flow_test.dart" ]; then
    echo "ERROR: pairing_flow_test.dart not found!"
    exit 1
fi

echo "Found integration tests:"
ls -la integration_test/

echo ""
echo "Setting up test environment..."
echo "  Mydia API: ${MYDIA_URL}"
echo ""

# Login to Mydia and get auth token
echo "Logging in as test admin..."
LOGIN_RESPONSE=$(curl -sf "${MYDIA_URL}/api/graphql" \
    -H "Content-Type: application/json" \
    -d '{
        "query": "mutation Login($input: LoginInput!) { login(input: $input) { token } }",
        "variables": {
            "input": {
                "username": "'"${E2E_ADMIN_EMAIL:-admin@test.local}"'",
                "password": "'"${E2E_ADMIN_PASSWORD:-testpassword123}"'",
                "deviceId": "e2e-test-runner",
                "deviceName": "E2E Test Runner",
                "platform": "web"
            }
        }
    }' 2>&1)

AUTH_TOKEN=$(echo "$LOGIN_RESPONSE" | jq -r '.data.login.token // empty')

if [ -z "$AUTH_TOKEN" ]; then
    echo "ERROR: Failed to login to Mydia"
    echo "Response: $LOGIN_RESPONSE"
    exit 1
fi
echo "  ✓ Login successful"

# Generate a claim code
echo "Generating claim code..."
CLAIM_RESPONSE=$(curl -sf "${MYDIA_URL}/api/graphql" \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer $AUTH_TOKEN" \
    -d '{
        "query": "mutation { generateClaimCode { code expiresAt } }"
    }' 2>&1)

CLAIM_CODE=$(echo "$CLAIM_RESPONSE" | jq -r '.data.generateClaimCode.code // empty')

if [ -z "$CLAIM_CODE" ]; then
    echo "ERROR: Failed to generate claim code"
    echo "Response: $CLAIM_RESPONSE"
    exit 1
fi
echo "  ✓ Claim code generated: $CLAIM_CODE"

echo ""
echo "Starting ChromeDriver..."
chromedriver --port=4444 --log-level=WARNING &
CHROMEDRIVER_PID=$!
sleep 2

if ! kill -0 $CHROMEDRIVER_PID 2>/dev/null; then
    echo "ERROR: ChromeDriver failed to start"
    exit 1
fi
echo "  ✓ ChromeDriver started (PID: $CHROMEDRIVER_PID)"

echo ""
echo "Running Flutter integration tests..."
echo "  Claim Code: $CLAIM_CODE"
echo ""

echo "  Flutter dart-define values:"
echo "    RELAY_URL=${RESOLVED_RELAY_URL}"
echo "    MYDIA_URL=${RESOLVED_MYDIA_URL}"
echo "    E2E_CLAIM_CODE=${CLAIM_CODE}"
echo ""

# Run Flutter drive tests with ChromeDriver
# --target: the integration test file
# -d web-server: use web-server device (required for web)
# --browser-name: specify chrome
# --driver: the test driver (handles communication)
# --dart-define: pass environment variables
#
# Note: Additional Chrome flags are needed for Docker:
# --no-sandbox: Required when running as root
# --disable-dev-shm-usage: Avoid /dev/shm issues in containers
# --disable-gpu: Disable GPU acceleration in headless mode

flutter drive \
    --target=integration_test/pairing_flow_test.dart \
    --driver=test_driver/integration_test.dart \
    -d web-server \
    --browser-name=chrome \
    --headless \
    --web-browser-flag="--no-sandbox" \
    --web-browser-flag="--disable-dev-shm-usage" \
    --web-browser-flag="--disable-gpu" \
    --dart-define=MYDIA_URL=${RESOLVED_MYDIA_URL} \
    --dart-define=RELAY_URL=${RESOLVED_RELAY_URL} \
    --dart-define=E2E_MODE=true \
    --dart-define=E2E_CLAIM_CODE=${CLAIM_CODE}

TEST_EXIT_CODE=$?

# Cleanup ChromeDriver
echo ""
echo "Stopping ChromeDriver..."
kill $CHROMEDRIVER_PID 2>/dev/null || true

echo ""
echo "============================================"
if [ $TEST_EXIT_CODE -eq 0 ]; then
    echo "E2E Tests PASSED!"
else
    echo "E2E Tests FAILED! (exit code: $TEST_EXIT_CODE)"
fi
echo "============================================"

exit $TEST_EXIT_CODE
EOF

RUN chmod +x /entrypoint.sh

# Default command
ENTRYPOINT ["/entrypoint.sh"]
