FROM ghcr.io/cirruslabs/flutter:stable

# Install development dependencies
RUN apt-get update -qq && \
    apt-get install -y -qq --no-install-recommends \
        inotify-tools \
        python3 \
        curl \
    && rm -rf /var/lib/apt/lists/*

# Pre-configure Flutter
RUN flutter config --no-analytics

WORKDIR /app/player

# Create entrypoint script
COPY <<'EOF' /entrypoint.sh
#!/bin/bash
set -e

cd /app/player

# Install dependencies
flutter pub get

# Run build_runner for code generation if needed
if [ -f "lib/graphql/schema.graphql.dart" ]; then
    echo "GraphQL codegen already exists, skipping build_runner..."
else
    echo "Running build_runner for code generation..."
    flutter pub run build_runner build --delete-conflicting-outputs || true
fi

MODE="${PLAYER_DEV_MODE:-watch}"

case "$MODE" in
    hot)
        echo ''
        echo '================================================='
        echo 'Flutter Web Development Server (Hot Restart)'
        echo '================================================='
        echo ''
        echo 'Access the player at: http://localhost:3000'
        echo ''
        echo 'Hot restart: Press "R" in this terminal'
        echo 'Hot reload:  Press "r" in this terminal'
        echo ''
        echo '================================================='
        echo ''

        # Run Flutter web server with hot restart support
        exec flutter run -d web-server \
            --web-port=3000 \
            --web-hostname=0.0.0.0
        ;;

    watch)
        echo 'Initial Flutter web build...'
        flutter build web --profile --no-web-resources-cdn --no-wasm-dry-run --dart-define=Dart2jsOptimization=O0 --base-href /player/
        rm -rf /app/priv/static/player
        mkdir -p /app/priv/static/player
        cp -r build/web/* /app/priv/static/player/

        echo ''
        echo '================================================='
        echo 'Flutter build complete!'
        echo 'Files synced to priv/static/player/'
        echo 'Access at http://localhost:4000/player'
        echo ''
        echo 'Watching for file changes in lib/...'
        echo 'Refresh browser after build completes.'
        echo '================================================='
        echo ''

        while true; do
            inotifywait -r -e modify,create,delete --exclude '\.dart_tool|build|\.git|\.tmp|\.g\.dart' lib/ 2>/dev/null
            echo ''
            echo '>>> File change detected, rebuilding...'
            if flutter build web --profile --no-web-resources-cdn --dart-define=Dart2jsOptimization=O0 --base-href /player/ 2>&1; then
                rm -rf /app/priv/static/player
                mkdir -p /app/priv/static/player
                cp -r build/web/* /app/priv/static/player/
                echo '>>> Build complete! Refresh browser to see changes.'
            else
                echo '>>> Build FAILED - check errors above'
            fi
        done
        ;;

    *)
        echo "Unknown PLAYER_DEV_MODE: $MODE"
        echo "Valid options: 'hot' or 'watch'"
        exit 1
        ;;
esac
EOF

RUN chmod +x /entrypoint.sh

# Default command runs the entrypoint
CMD ["/entrypoint.sh"]
