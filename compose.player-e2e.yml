# Docker Compose for Player E2E Integration Tests
#
# This runs the full stack with Flutter integration tests:
# - metadata-relay: Relay service for NAT traversal
# - mydia: Main application
# - player: Flutter web app served via nginx
# - chrome: Selenium Chrome for UI testing (shares network with test container)
# - test: Flutter integration test runner
#
# How it works:
# Flutter's integration_test package hardcodes 'localhost' URLs when telling Chrome
# where to navigate. To work around this, Chrome shares the test container's network
# namespace via network_mode: service:test. This means 'localhost' in Chrome resolves
# to the test container where the Flutter web server runs on port 4040.
#
# Performance optimizations:
# - BuildKit enabled for cache mounts (DOCKER_BUILDKIT=1)
# - Reduced service dependencies for faster parallel startup
# - Pre-build with: ./dev player e2e-build
#
# Usage:
#   DOCKER_BUILDKIT=1 docker compose -f compose.player-e2e.yml build
#   docker compose -f compose.player-e2e.yml up --abort-on-container-exit
#   docker compose -f compose.player-e2e.yml down -v

services:
  # ============================================
  # Metadata Relay Service
  # ============================================
  relay:
    build:
      context: ./metadata-relay
      dockerfile: Dockerfile
    container_name: e2e_relay
    environment:
      PORT: "4001"
      SQLITE_DB_PATH: /data/relay.db
      # No API keys needed for E2E tests (not testing metadata fetching)
    volumes:
      - relay_data:/data
    ports:
      - "14001:4001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4001/health"]
      interval: 2s
      timeout: 2s
      start_period: 5s
      retries: 10
    networks:
      - e2e

  # ============================================
  # Mydia Main Application
  # ============================================
  mydia:
    build:
      context: .
      dockerfile: Dockerfile.e2e
    container_name: e2e_mydia
    environment:
      # Phoenix config
      PHX_HOST: mydia
      PHX_SERVER: "true"
      PORT: "4000"
      HTTPS_PORT: "4443"
      SECRET_KEY_BASE: "E2ETestSecretKeyBase123456789012345678901234567890123456789012345"
      GUARDIAN_SECRET_KEY: "E2ETestGuardianSecretKey12345678901234567890123456789012345678"

      # Database
      DATABASE_PATH: /config/mydia.db
      MIX_ENV: prod

      # Relay connection
      METADATA_RELAY_URL: "http://relay:4001"

      # E2E test mode - auto-enable remote access
      E2E_MODE: "true"
      E2E_ADMIN_EMAIL: "admin@test.local"
      E2E_ADMIN_PASSWORD: "testpassword123"

      # Disable HTTPS origin checks for E2E
      PHX_CHECK_ORIGIN: "false"

      # Direct URLs config - include Docker hostname for internal access
      EXTERNAL_PORT: "4000"
      PUBLIC_IP_ENABLED: "false"
      ADDITIONAL_DIRECT_URLS: "http://mydia:4000"
    volumes:
      - mydia_config:/config
      - mydia_data:/data
    ports:
      - "14000:4000"
      - "14443:4443"
    depends_on:
      relay:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 2s
      timeout: 2s
      start_period: 15s
      retries: 20
    networks:
      - e2e

  # ============================================
  # Flutter Web Player (served via nginx)
  # ============================================
  # Note: player doesn't need to depend on mydia - it's just static files
  # The test runner will wait for mydia to be healthy
  player:
    build:
      context: .
      dockerfile: player/Dockerfile.e2e
      args:
        # Bake in the relay URL at build time
        RELAY_URL: "http://relay:4001"
        MYDIA_URL: "http://mydia:4000"
    container_name: e2e_player
    ports:
      - "18080:80"
    # No depends_on - player is just nginx serving static files
    # This allows it to start immediately while other services spin up
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 2s
      timeout: 2s
      start_period: 5s
      retries: 5
    networks:
      - e2e

  # ============================================
  # Flutter Integration Test Runner
  # ============================================
  # The test container runs the Flutter web server on port 4040.
  # Chrome shares this container's network namespace, so localhost:4040
  # in Chrome reaches the Flutter web server correctly.
  test:
    build:
      context: .
      dockerfile: player/Dockerfile.test
    container_name: e2e_test
    environment:
      # WebDriver configuration - Chrome is at localhost since we share network
      CHROMEDRIVER_URL: "http://localhost:4444"

      # Web port for Flutter web server (Chrome will reach this via localhost)
      WEB_PORT: "4040"

      # Backend service URLs (test container is on the e2e network)
      MYDIA_URL: "http://mydia:4000"
      RELAY_URL: "http://relay:4001"

      # Test admin credentials
      E2E_ADMIN_EMAIL: "admin@test.local"
      E2E_ADMIN_PASSWORD: "testpassword123"
    depends_on:
      mydia:
        condition: service_healthy
    networks:
      - e2e
    # Test runner exits when done

  # ============================================
  # Selenium Chrome (for UI testing)
  # ============================================
  # Chrome shares the test container's network namespace via network_mode.
  # This means 'localhost' in Chrome resolves to the test container, allowing
  # Flutter's hardcoded localhost URLs to work correctly.
  chrome:
    image: selenium/standalone-chrome:131.0
    container_name: e2e_chrome
    shm_size: "2g"
    environment:
      SE_NODE_MAX_SESSIONS: "1"
      SE_NODE_SESSION_TIMEOUT: "300"
    # Share network namespace with test container - localhost in Chrome = test container
    network_mode: service:test
    # Note: No ports exposed here since we share test's network namespace.
    # WebDriver is accessible at localhost:4444 from the test container.
    # VNC debugging is available at localhost:7900 from the test container.
    depends_on:
      - test
    # Health check runs in the shared namespace
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4444/status"]
      interval: 2s
      timeout: 2s
      start_period: 5s
      retries: 10

networks:
  e2e:
    driver: bridge

volumes:
  relay_data:
    driver: local
  mydia_config:
    driver: local
  mydia_data:
    driver: local
