# Dockerfile for building Android APKs with Flutter + Rust (flutter_rust_bridge)
# This image includes Flutter, Android SDK/NDK, and Rust with Android targets

FROM ghcr.io/cirruslabs/flutter:stable

# Install system dependencies
RUN apt-get update -qq && \
    apt-get install -y -qq --no-install-recommends \
        curl \
        build-essential \
        pkg-config \
        libssl-dev \
        unzip \
    && rm -rf /var/lib/apt/lists/*

# Install Rust with Android targets
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
ENV PATH="/root/.cargo/bin:${PATH}"

# Add Android targets for Rust
RUN rustup target add aarch64-linux-android armv7-linux-androideabi x86_64-linux-android i686-linux-android

# Install cargo-ndk for easier Android builds
RUN cargo install cargo-ndk

# Set up Android NDK environment
# The cirruslabs/flutter image already has Android SDK, we just need to ensure NDK is available
ENV ANDROID_HOME=/opt/android-sdk-linux
ENV ANDROID_SDK_ROOT=/opt/android-sdk-linux

# Install NDK 27.0.12077973 (required by the project)
RUN yes | sdkmanager --install "ndk;27.0.12077973" "cmake;3.22.1"
ENV ANDROID_NDK_HOME=${ANDROID_HOME}/ndk/27.0.12077973
ENV NDK_HOME=${ANDROID_NDK_HOME}

# Set up linker environment variables for Rust cross-compilation
ENV CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang
ENV CARGO_TARGET_ARMV7_LINUX_ANDROIDEABI_LINKER=${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang
ENV CARGO_TARGET_X86_64_LINUX_ANDROID_LINKER=${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android21-clang
ENV CARGO_TARGET_I686_LINUX_ANDROID_LINKER=${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android21-clang

# CC environment variables
ENV CC_aarch64_linux_android=${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang
ENV CC_armv7_linux_androideabi=${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang
ENV CC_x86_64_linux_android=${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android21-clang
ENV CC_i686_linux_android=${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android21-clang

# AR environment variables
ENV AR_aarch64_linux_android=${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
ENV AR_armv7_linux_androideabi=${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
ENV AR_x86_64_linux_android=${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
ENV AR_i686_linux_android=${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar

# Pre-configure Flutter
RUN flutter config --no-analytics

WORKDIR /app/player

# Install gradle for wrapper generation
RUN apt-get update -qq && \
    apt-get install -y -qq --no-install-recommends gradle && \
    rm -rf /var/lib/apt/lists/*

# Create build script
COPY <<'EOF' /build-android.sh
#!/bin/bash
set -e

cd /app/player

echo ''
echo '================================================='
echo 'Flutter Player - Android Build'
echo '================================================='
echo ''

# Delete local.properties if it exists (may have stale Nix paths)
rm -f android/local.properties

# Generate gradlew if missing (it's in .gitignore)
if [ ! -f "android/gradlew" ]; then
    echo '-> Generating Gradle wrapper...'
    cd android
    gradle wrapper --gradle-version 8.3
    cd ..
fi
chmod +x android/gradlew

# Install Flutter dependencies
echo '-> Installing Flutter dependencies...'
flutter pub get

# Run code generation (ignore errors from GraphQL if schema is missing)
echo '-> Running code generation...'
flutter pub run build_runner build --delete-conflicting-outputs 2>&1 || echo "Warning: Code generation had errors (may be expected if GraphQL schema is not available)"

# Build APK
echo '-> Building Android APK...'
flutter build apk --debug

echo ''
echo '================================================='
echo 'Build complete!'
echo 'APK location: build/app/outputs/flutter-apk/app-debug.apk'
echo '================================================='
EOF

RUN chmod +x /build-android.sh

CMD ["/build-android.sh"]
