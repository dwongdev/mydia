# syntax=docker/dockerfile:1.4
# ============================================
# E2E Test Runner - Flutter Integration Tests
# ============================================
# This Dockerfile runs Flutter integration tests against
# a Selenium Chrome instance that shares our network namespace.
#
# How it works:
# In docker-compose, Chrome uses `network_mode: service:test` to share this
# container's network namespace. This means:
# 1. Chrome listens on localhost:4444 (WebDriver) from this container's perspective
# 2. When Flutter tells Chrome to navigate to localhost:4040, Chrome reaches
#    our Flutter web server directly (since localhost is shared)
#
# NOTE: This Dockerfile expects the build context to be the project root
# (not the player directory) so it can access priv/graphql/schema.graphql
#
# Build with: DOCKER_BUILDKIT=1 docker build -f player/Dockerfile.test .
#
# Environment variables required:
# - CHROMEDRIVER_URL: URL of the Selenium WebDriver (default: http://localhost:4444)
# - WEB_PORT: Port for the Flutter web server (default: 4040)
# - MYDIA_URL: URL of the Mydia server (for API calls)
# - RELAY_URL: URL of the metadata-relay service

FROM ghcr.io/cirruslabs/flutter:stable

# Set pub cache location for caching
ENV PUB_CACHE=/root/.pub-cache

# Install additional dependencies
RUN apt-get update -qq && \
    apt-get install -y -qq --no-install-recommends \
        curl \
        jq \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy pubspec files first for better caching
COPY player/pubspec.yaml player/pubspec.lock ./

# Install dependencies with cache
RUN --mount=type=cache,target=/root/.pub-cache \
    flutter pub get && \
    cp -r /root/.pub-cache /tmp/.pub-cache-copy

# Copy the rest of the player app
COPY player/ .

# Remove the broken symlink and copy the actual schema file
RUN rm -f lib/graphql/schema.graphql
COPY priv/graphql/schema.graphql lib/graphql/schema.graphql

# Run build_runner for code generation with cache
RUN --mount=type=cache,target=/root/.pub-cache \
    cp -r /tmp/.pub-cache-copy/* /root/.pub-cache/ 2>/dev/null || true && \
    flutter pub run build_runner build --delete-conflicting-outputs

# Copy the test entrypoint script
COPY <<'EOF' /entrypoint.sh
#!/bin/bash
set -e

CHROMEDRIVER_URL="${CHROMEDRIVER_URL:-http://localhost:4444}"
WEB_PORT="${WEB_PORT:-4040}"

echo "============================================"
echo "Flutter E2E Integration Test Runner"
echo "============================================"
echo ""
echo "Configuration:"
echo "  CHROMEDRIVER_URL: ${CHROMEDRIVER_URL}"
echo "  WEB_PORT: ${WEB_PORT}"
echo "  MYDIA_URL: ${MYDIA_URL:-not set}"
echo "  RELAY_URL: ${RELAY_URL:-not set}"
echo ""
echo "Network namespace sharing is enabled - Chrome container shares"
echo "our network namespace, so localhost in Chrome reaches this container."
echo ""

# Wait for Mydia to be ready first (Chrome depends on us starting)
echo "Waiting for Mydia..."
max_attempts=30
attempt=0
while [ $attempt -lt $max_attempts ]; do
    if curl -sf "${MYDIA_URL}/health" > /dev/null 2>&1; then
        echo "  ✓ Mydia is ready!"
        break
    fi
    attempt=$((attempt + 1))
    echo "  Attempt $attempt/$max_attempts..."
    sleep 2
done

if [ $attempt -eq $max_attempts ]; then
    echo "ERROR: Mydia not available at ${MYDIA_URL}"
    exit 1
fi

# Wait for Chrome to be ready (Chrome shares our network namespace)
# Chrome container depends on us and starts after, so we need to wait
echo ""
echo "Waiting for Selenium Chrome (shared network namespace)..."
attempt=0
while [ $attempt -lt $max_attempts ]; do
    if curl -sf "${CHROMEDRIVER_URL}/status" > /dev/null 2>&1; then
        echo "  ✓ Selenium Chrome is ready at ${CHROMEDRIVER_URL}!"
        break
    fi
    attempt=$((attempt + 1))
    echo "  Attempt $attempt/$max_attempts..."
    sleep 2
done

if [ $attempt -eq $max_attempts ]; then
    echo "ERROR: Selenium Chrome not available at ${CHROMEDRIVER_URL}"
    exit 1
fi

echo ""
echo "All services ready!"
echo "============================================"
echo ""

# Verify integration test files exist
if [ ! -f "integration_test/pairing_flow_test.dart" ]; then
    echo "ERROR: pairing_flow_test.dart not found!"
    exit 1
fi

echo "Found integration tests:"
ls -la integration_test/

# Create test driver
mkdir -p test_driver
cat > test_driver/integration_test.dart << 'DART'
import 'package:integration_test/integration_test_driver.dart';

Future<void> main() {
  return integrationDriver();
}
DART

echo ""
echo "Setting up test environment..."
echo "  Mydia API: ${MYDIA_URL}"
echo "  Web Server: localhost:${WEB_PORT}"
echo ""

# Login to Mydia and get auth token
echo "Logging in as test admin..."
LOGIN_RESPONSE=$(curl -sf "${MYDIA_URL}/api/graphql" \
    -H "Content-Type: application/json" \
    -d '{
        "query": "mutation Login($input: LoginInput!) { login(input: $input) { token } }",
        "variables": {
            "input": {
                "username": "'"${E2E_ADMIN_EMAIL:-admin@test.local}"'",
                "password": "'"${E2E_ADMIN_PASSWORD:-testpassword123}"'",
                "deviceId": "e2e-test-runner",
                "deviceName": "E2E Test Runner",
                "platform": "web"
            }
        }
    }' 2>&1)

AUTH_TOKEN=$(echo "$LOGIN_RESPONSE" | jq -r '.data.login.token // empty')

if [ -z "$AUTH_TOKEN" ]; then
    echo "ERROR: Failed to login to Mydia"
    echo "Response: $LOGIN_RESPONSE"
    exit 1
fi
echo "  ✓ Login successful"

# Generate a claim code
echo "Generating claim code..."
CLAIM_RESPONSE=$(curl -sf "${MYDIA_URL}/api/graphql" \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer $AUTH_TOKEN" \
    -d '{
        "query": "mutation { generateClaimCode { code expiresAt } }"
    }' 2>&1)

CLAIM_CODE=$(echo "$CLAIM_RESPONSE" | jq -r '.data.generateClaimCode.code // empty')

if [ -z "$CLAIM_CODE" ]; then
    echo "ERROR: Failed to generate claim code"
    echo "Response: $CLAIM_RESPONSE"
    exit 1
fi
echo "  ✓ Claim code generated: $CLAIM_CODE"

echo ""
echo "Running Flutter integration tests..."
echo "  WebDriver: ${CHROMEDRIVER_URL}"
echo "  Web Server: localhost:${WEB_PORT} (Chrome reaches via shared namespace)"
echo "  Claim Code: $CLAIM_CODE"
echo ""

# Run Flutter integration tests
# - Uses 'web-server' device which serves the app on localhost:${WEB_PORT}
# - Chrome shares our network namespace so localhost:${WEB_PORT} works
# - dart-define passes environment to the Flutter app at compile time

flutter drive \
    --driver=test_driver/integration_test.dart \
    --target=integration_test/pairing_flow_test.dart \
    -d web-server \
    --web-port=${WEB_PORT} \
    --dart-define=MYDIA_URL=${MYDIA_URL} \
    --dart-define=RELAY_URL=${RELAY_URL} \
    --dart-define=E2E_MODE=true \
    --dart-define=E2E_CLAIM_CODE=${CLAIM_CODE}

TEST_EXIT_CODE=$?

echo ""
echo "============================================"
if [ $TEST_EXIT_CODE -eq 0 ]; then
    echo "E2E Tests PASSED!"
else
    echo "E2E Tests FAILED! (exit code: $TEST_EXIT_CODE)"
fi
echo "============================================"

exit $TEST_EXIT_CODE
EOF

RUN chmod +x /entrypoint.sh

# Default command
ENTRYPOINT ["/entrypoint.sh"]
